---
title: "nvim-dap ã§ neovim ã§ã‚‚ Python ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒãƒƒã‚°ã—ãŸã„"
emoji: "ğŸ›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["neovim", "python"]
published: false
---
Python ã®ãƒ‡ãƒãƒƒã‚¬ã¨ã„ãˆã° [pudb](https://github.com/inducer/pudb) ãŒä¾¿åˆ©ã§ã™ãŒã€ã‚„ã£ã±ã‚Š IDE ãƒ©ã‚¤ã‚¯ã«ãƒ‡ãƒãƒƒã‚°ã—ãŸã„ã€ã§ã‚‚ neovim ã‹ã‚‰ VSCode ã«ã¯ä¹—ã‚Šæ›ãˆãŸããªã„ã€ã¨ã„ã†ã“ã¨ã§ã„ã‚ã„ã‚ã¨èª¿æŸ»ã—ãŸçµæœã€[nvim-dap]() ãŒè‰¯ã•ãã†ã§ã—ãŸã®ã§å°å…¥æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# DAP ã‚’ä½¿ãˆã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
vim / neovim ã§ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¯

- [vimspector](https://github.com/puremourning/vimspector/)
- [nvim-dap](https://github.com/mfussenegger/nvim-dap/)

ãŒã‚ã‚Šã€ã©ã¡ã‚‰ã‚‚ Debug Adapter Protocol (DAP) ã§ãã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ‡ã‚£ã‚¿ã¨ãƒ‡ãƒãƒƒã‚¬ã®é–“ã‚’ DAP ãŒä»²ä»‹ã™ã‚‹ã“ã¨ã§ã€ã©ã‚“ãªã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã§ã‚‚ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã‚’å®Ÿç¾ã§ãã‚‹ã€ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã§ã™ã€‚LSP ã® ãƒ‡ãƒãƒƒã‚¬ç‰ˆã€ã¨ã„ã£ãŸã¨ã“ã‚ã§ã—ã‚‡ã†ã‹ã€‚ã¡ãªã¿ã« LSP ã¨ DAP ã¯ã©ã¡ã‚‰ã‚‚ MS è£½ã€‚

ä»Šå›ã¯ `nvim-dap` ã§ Python ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒãƒƒã‚°ãŒã§ãã‚‹ã‚ˆã†è¨­å®šã—ã¦ã„ãã¾ã™ã€‚

# nvim-dap, nvim-dap-ui, nvim-dap-python ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
nvim-dap ã ã‘ã§ã¯ UI ãŒæä¾›ã•ã‚Œãªã„ã®ã§ã€[nvim-dap-ui](https://github.com/rcarriga/nvim-dap-ui) ã‚’ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€Python ç”¨ nvim-dap è¨­å®šãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã‚ã‚‹ [nvim-dap-python](https://github.com/mfussenegger/nvim-dap-python) ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚
ç§ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã¨ã—ã¦ packer.nvim ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã‚’ `~/.config/nvim/lua/plugins.lua` ã«è¨˜è¿°ã€`:PackerInstall` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚
```lua
use "mfussenegger/nvim-dap"
use "rcarriga/nvim-dap-ui"
use "https://github.com/mfussenegger/nvim-dap-python"
```
ã“ã‚Œã§ nvim-dap ã¨ nvim-dap-ui ã®ä¸¡æ–¹ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

# Python ä»®æƒ³ç’°å¢ƒä¸‹ã« Python ãƒ‡ãƒãƒƒã‚¬ `debugpy` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
DAP ã«å¯¾å¿œã—ã¦ã„ã‚‹ Python ãƒ‡ãƒãƒƒã‚¬ã¨ã—ã¦ [debugpy](https://github.com/microsoft/debugpy) ãŒã‚ã‚Šã€VSCode ã§ã® Python ã®ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã«ã‚‚ã“ã‚ŒãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ãªãŠ MS è£½ã€‚ã“ã„ã¤ã‚’ä»®æƒ³ç’°å¢ƒä¸‹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€`nvim-dap` ã«èªè­˜ã•ã›ã¾ã™ã€‚
ç§ã¯ [pipenv](https://pipenv.pypa.io/en/latest/) ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€é©å½“ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ˜ã£ã¦ãã“ã« `debugpy` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
```console
$ pipenv install --dev debugpy
```
ã¾ãŸã€[direnv](https://github.com/direnv/direnv) ã‚’ä½¿ã£ã¦è‡ªå‹•çš„ã«ä»®æƒ³ç’°å¢ƒã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã‚‹ã®ã§ `.envrc` ã«
```
layout pipenv
```
ã¨è¨˜è¿°ã—ã¦ãŠãã¾ã™ã€‚ã“ã‚Œã§ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `cd` ã™ã‚‹ã ã‘ã§ä»®æƒ³ç’°å¢ƒãŒ `activate` ã•ã‚Œã¾ã™ã€‚

# nvim-dap-python ã®è¨­å®š
`nvim-dap-python`ã‚’ä½¿ã‚ãªãã¦ã‚‚ `nvim-dap` ã‚’[Python ç”¨ã«è¨­å®šã§ãã‚‹](https://github.com/mfussenegger/nvim-dap/wiki/Debug-Adapter-installation#Python) ã®ã§ã™ãŒã€`nvim-dap-python` ã‚’ä½¿ãˆã°ã‚¯ãƒ©ã‚¹ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’ `nvim-dap` ã‹ã‚‰èµ°ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
`nvim-dap-python` ã®è¨­å®šã¯ã¨ã¦ã‚‚ç°¡å˜ã§ã€`debugpy` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸä»®æƒ³ç’°å¢ƒã® Python ã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚’æ¸¡ã™ã ã‘ã§ã™ã€‚ä»®æƒ³ç’°å¢ƒã®ãƒ‘ã‚¹ã‚’è‡ªå‹•ã§å–å¾—ã™ã‚‹ãŸã‚ã€ã¡ã‚‡ã£ã¨ã ã‘å·¥å¤«ã—ã¾ã™ã€‚
```lua
local venv = os.getenv('VIRTUAL_ENV')
command = string.format('%s/bin/python', venv)

require('dap-python').setup(command)
```
`direnv` ã®ãŠã‹ã’ã§ä»®æƒ³ç’°å¢ƒä¸‹ã« `cd` ã—ã¦ã„ã‚Œã°è‡ªå‹•ã§ä»®æƒ³ç’°å¢ƒãŒ `activate` ã•ã‚Œã€ç’°å¢ƒå¤‰æ•° `VIRTUAL_ENV` ãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ãã‚Œã‚’èª­ã¿å–ã£ã¦ `/bin/python` ã‚’ãã£ã¤ã‘ã¦å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¨ã—ã¦ã„ã¾ã™ã€‚

# nvim-dap ã®è¨­å®š
ã‚­ãƒ¼ãƒãƒƒãƒ—ã‚’è¨­å®šã—ã¦ã„ãã¾ã™ã€‚ãªãœãªã‚‰...
> nvim-dap does not configure any mappings by default.

ç¡¬æ´¾ã§ã™ã­ã€‚VSCode ã«å¯„ã›ã‚‹è¨­å®šãŒ `nvim-dap` ã®ãƒ˜ãƒ«ãƒ—ã«ã‚ã‚Šã¾ã—ãŸã®ã§ `lua` ã«å¤‰æ›´ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚
```lua
vim.api.nvim_set_keymap('n', '<F5>', ':DapContinue<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<F10>', ':DapStepOver<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<F11>', ':DapStepInto<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<F12>', ':DapStepOut<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<leader>b', ':DapToggleBreakpoint<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<leader>B', ':lua require("dap").set_breakpoint(nil, nil, vim.fn.input("Breakpoint condition: "))<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<leader>lp', ':lua require("dap").set_breakpoint(nil, nil, vim.fn.input("Log point message: "))<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<leader>dr', ':lua require("dap").repl.open()<CR>', { silent = true })
vim.api.nvim_set_keymap('n', '<leader>dl', ':lua require("dap").run_last()<CR>', { silent = true })
```

# nvim-dap-ui ã®è¨­å®š
## dap-ui ã®èµ·å‹•ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
VSCode ã«åˆã‚ã›ã¦ `Ctrl+Shift+D` ã§èµ·å‹•ã•ã›ãŸã‹ã£ãŸã®ã§ã™ãŒã€ç„¡ç†ã ã£ãŸã®ã§ `<leader>d` ã§å¦¥å”ã—ã¦ã„ã¾ã™ã€‚

```lua
vim.api.nvim_set_keymap('n', '<leader>d', ':lua require("dapui").toggle()<CR>', {})
```

## ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å¤‰æ›´
ç¾çŠ¶ä½¿ã„ã“ãªã›ã¦ã„ãªã„ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚‚ååˆ†ãªã®ã§ã™ãŒã€

- ã‚¢ã‚¤ã‚³ãƒ³ã®å¤‰æ›´
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å¤‰æ›´ï¼ˆå³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€`scopes` ã‚’ä¸€ç•ªä¸Šã«ï¼‰
- ã‚µã‚¤ã‚ºã®èª¿æ•´

ã‚’ã—ã¦ã„ã¾ã™ã€‚
```lua
require("dapui").setup({
  icons = { expanded = "ï‘¼", collapsed = "ï‘ " },
  layouts = {
    {
      elements = {
        { id = "watches", size = 0.20 },
        { id = "stacks", size = 0.20 },
        { id = "breakpoints", size = 0.20 },
        { id = "scopes", size = 0.40 },
      },
      size = 64,
      position = "right",
    },
    {
      elements = {
        "repl",
        "console",
      },
      size = 0.20,
      position = "bottom",
    },
  },
})
```

# å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹
ä»¥ä¸Šã®è¨­å®šã‚’çµ‚ãˆãŸã‚‰é©å½“ãª `python` ãƒ•ã‚¡ã‚¤ãƒ«ã§ `<leader>d` ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€`nvim-dap-ui` ãŒèµ·å‹•ã—ã¦ãã‚Œã¾ã™ã€‚é–‰ã˜ã‚‹ã¨ãã‚‚ `<leader>d`ã€‚
ä¸Šè¨˜ã®ã‚­ãƒ¼ãƒãƒƒãƒ—ã§ã‚ã‚Œã°ã€ã“ã‚“ãªæ„Ÿã˜ã§ãƒ‡ãƒãƒƒã‚°ã§ãã¾ã™ã€‚
| ã‚­ãƒ¼ | èª¬æ˜ |
| ---- | ---- |
| <F5> | ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ |
| <F10> | ã‚¹ãƒ†ãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ |
| <F12> | ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ |
| <leader>b | ãƒ–ãƒ¬ã‚¤ã‚¯ãƒã‚¤ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ |

ã¾ãŸã€ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®å¤‰æ•°ã«å¯¾ã—ã¦ `:lua require("dapui").eval()` ã™ã‚‹ã¨ãƒ›ãƒãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«å€¤ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
å‹•ä½œã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
![](/images/06eabde3811d870c3ef48d99dd81b196.png)



# ã‚ã¨ãŒã
ã•ã™ãŒ MSã€‚å®—æ—¨æ›¿ãˆã—ã¦ VSCode ã‚’ä½¿ãˆã°å¹¸ã›ã«ãªã‚Œãã†...
ä»Šå¾Œã¯ã“ã‚Œã‚’æ©Ÿã« `print()` ãƒ‡ãƒãƒƒã‚°ã€`ipython` ã«ã‚ˆã‚‹ãƒ‡ãƒãƒƒã‚°ã‹ã‚‰å’æ¥­ã—ã¾ã™ã€‚
